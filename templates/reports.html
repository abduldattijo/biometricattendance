{% extends "base.html" %}

{% block title %}Attendance Reports - Face Recognition Attendance{% endblock %}

{% block content %}
<div class="container">
    <h1 class="mb-4">
        <i class="bi bi-file-earmark-text-fill"></i> Attendance Reports
    </h1>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">Filter Reports</h5>
            <form id="filter-form" class="row g-3">
                <div class="col-md-4">
                    <label for="start-date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="start-date" required>
                </div>
                <div class="col-md-4">
                    <label for="end-date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="end-date" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-search"></i> Generate Report
                        </button>
                        <button type="button" id="export-btn" class="btn btn-success">
                            <i class="bi bi-download"></i> Export CSV
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-table"></i> Attendance Records
                <span id="record-count" class="badge bg-light text-dark ms-2">0</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Employee ID</th>
                            <th>Name</th>
                            <th>Confidence</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body">
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                Select date range and click "Generate Report"
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="no-records" class="text-center text-muted py-5" style="display: none;">
                <i class="bi bi-inbox" style="font-size: 64px;"></i>
                <h4 class="mt-3">No Records Found</h4>
                <p>No attendance records found for the selected date range</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let currentRecords = [];

    // Set default dates (last 7 days to today)
    const today = new Date();
    const weekAgo = new Date();
    weekAgo.setDate(today.getDate() - 7);

    document.getElementById('start-date').valueAsDate = weekAgo;
    document.getElementById('end-date').valueAsDate = today;

    // Generate report
    document.getElementById('filter-form').addEventListener('submit', function(e) {
        e.preventDefault();
        generateReport();
    });

    function generateReport() {
        const startDate = document.getElementById('start-date').value;
        const endDate = document.getElementById('end-date').value;

        if (!startDate || !endDate) {
            showToast('Please select both start and end dates', 'error');
            return;
        }

        const tbody = document.getElementById('report-table-body');
        tbody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border text-primary"></div></td></tr>';

        fetch(`/api/attendance/report?start_date=${startDate}&end_date=${endDate}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentRecords = data.records;
                    displayRecords(data.records);
                    document.getElementById('record-count').textContent = data.count;
                } else {
                    showToast('Failed to generate report: ' + data.error, 'error');
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading report</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error generating report:', error);
                showToast('Error generating report', 'error');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading report</td></tr>';
            });
    }

    function displayRecords(records) {
        const tbody = document.getElementById('report-table-body');
        tbody.innerHTML = '';

        if (records.length === 0) {
            document.getElementById('no-records').style.display = 'block';
            tbody.closest('table').style.display = 'none';
            return;
        }

        document.getElementById('no-records').style.display = 'none';
        tbody.closest('table').style.display = 'table';

        records.forEach(record => {
            const timestamp = new Date(record.timestamp);
            const date = timestamp.toLocaleDateString();
            const time = timestamp.toLocaleTimeString();
            const confidence = record.confidence ?
                `<span class="badge bg-success">${(record.confidence * 100).toFixed(1)}%</span>` :
                `<span class="badge bg-secondary">Manual</span>`;

            const row = `
                <tr>
                    <td>${date}</td>
                    <td>${time}</td>
                    <td>${record.employee_id}</td>
                    <td>${record.employee_name}</td>
                    <td>${confidence}</td>
                    <td><span class="badge bg-success">Present</span></td>
                </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
        });
    }

    // Export to CSV
    document.getElementById('export-btn').addEventListener('click', function() {
        if (currentRecords.length === 0) {
            showToast('No records to export. Generate a report first.', 'error');
            return;
        }

        const csv = convertToCSV(currentRecords);
        downloadCSV(csv, 'attendance_report.csv');
        showToast('Report exported successfully', 'success');
    });

    function convertToCSV(records) {
        const headers = ['Date', 'Time', 'Employee ID', 'Name', 'Confidence', 'Status'];
        let csv = headers.join(',') + '\n';

        records.forEach(record => {
            const timestamp = new Date(record.timestamp);
            const date = timestamp.toLocaleDateString();
            const time = timestamp.toLocaleTimeString();
            const confidence = record.confidence ? (record.confidence * 100).toFixed(1) + '%' : 'Manual';

            const row = [
                date,
                time,
                record.employee_id,
                `"${record.employee_name}"`,
                confidence,
                record.status
            ];
            csv += row.join(',') + '\n';
        });

        return csv;
    }

    function downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }

    // Auto-generate report on page load
    generateReport();
</script>
{% endblock %}
